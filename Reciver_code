#include <WiFi.h>
#include <esp_now.h>
#include <esp_wifi.h>
#include <Wire.h>

uint8_t receiverMAC[] = {0xB0, 0xA7, 0x32, 0xD8, 0xA3, 0x58};

const int MPU6500_ADDR = 0x68;

typedef struct {
  int servo1;
  int servo2;
  int servo3;
  int servo4;
  bool emergency_stop;
} ServoControlData;

ServoControlData controlData;
esp_now_peer_info_t peerInfo;

float accelX, accelY, accelZ;
float pitch, roll;
bool mpuConnected = false;

float pitchOffset = 0;
float rollOffset = 0;

bool initMPU6500() {
  Wire.begin();
  Wire.beginTransmission(MPU6500_ADDR);
  Wire.write(0x6B);
  Wire.write(0x00);
  byte error = Wire.endTransmission();
  
  if (error == 0) {
    Serial.println("MPU6500 connected successfully!");
    
    Wire.beginTransmission(MPU6500_ADDR);
    Wire.write(0x1C);
    Wire.write(0x00);
    Wire.endTransmission();
    
    return true;
  } else {
    Serial.println("MPU6500 connection failed!");
    return false;
  }
}

void readMPU6500() {
  Wire.beginTransmission(MPU6500_ADDR);
  Wire.write(0x3B);
  Wire.endTransmission(false);
  Wire.requestFrom(MPU6500_ADDR, 6, true);
  
  if (Wire.available() >= 6) {
    int16_t rawAccelX = Wire.read() << 8 | Wire.read();
    int16_t rawAccelY = Wire.read() << 8 | Wire.read();
    int16_t rawAccelZ = Wire.read() << 8 | Wire.read();
    
    accelX = rawAccelX / 16384.0;
    accelY = rawAccelY / 16384.0;
    accelZ = rawAccelZ / 16384.0;
    
    pitch = atan2(accelY, sqrt(accelX * accelX + accelZ * accelZ)) * 180.0 / PI;
    roll = atan2(-accelX, accelZ) * 180.0 / PI;
    
    pitch -= pitchOffset;
    roll -= rollOffset;
  }
}

void calibrateMPU6500() {
  Serial.println("Calibrating MPU6500... Keep device level!");
  
  float pitchSum = 0, rollSum = 0;
  int samples = 100;
  
  for (int i = 0; i < samples; i++) {
    readMPU6500();
    pitchSum += pitch;
    rollSum += roll;
    delay(10);
  }
  
  pitchOffset = pitchSum / samples;
  rollOffset = rollSum / samples;
  
  Serial.println("Calibration complete!");
  Serial.print("Pitch offset: "); Serial.println(pitchOffset);
  Serial.print("Roll offset: "); Serial.println(rollOffset);
}

void onDataSent(const uint8_t *mac_addr, esp_now_send_status_t status) {
  if (status == ESP_NOW_SEND_SUCCESS) {
    Serial.println("✓ Data sent successfully");
  } else {
    Serial.println("✗ ERROR SENDING DATA");
    Serial.println("Check receiver MAC address and WiFi connection");
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("=== MPU6500 Gesture Car Controller ===");
  
  mpuConnected = initMPU6500();
  if (!mpuConnected) {
    Serial.println("Failed to initialize MPU6500!");
    Serial.println("Check wiring: SDA=21, SCL=22, VCC=3.3V, GND=GND");
    while (1) delay(1000);
  }
  
  delay(2000);
  calibrateMPU6500();
  
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  
  esp_wifi_set_channel(1, WIFI_SECOND_CHAN_NONE);
  
  delay(1000);
  
  Serial.print("Sender MAC Address: ");
  Serial.println(WiFi.macAddress());
  Serial.print("Target Receiver MAC: ");
  for(int i = 0; i < 6; i++) {
    Serial.printf("%02X", receiverMAC[i]);
    if(i < 5) Serial.print(":");
  }
  Serial.println();
  
  if (esp_now_init() != ESP_OK) {
    Serial.println("ESP-NOW initialization failed");
    return;
  }
  
  esp_now_register_send_cb(onDataSent);
  
  memset(&peerInfo, 0, sizeof(peerInfo));
  memcpy(peerInfo.peer_addr, receiverMAC, 6);
  peerInfo.channel = 1;
  peerInfo.encrypt = false;
  peerInfo.ifidx = WIFI_IF_STA;
  
  esp_now_del_peer(receiverMAC);
  
  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
    Serial.println("❌ Failed to add peer");
    Serial.println("Troubleshooting steps:");
    Serial.println("1. Check if receiver is powered on");
    Serial.println("2. Verify MAC address is correct");
    Serial.println("3. Try restarting both devices");
    return;
  } else {
    Serial.println("✅ Peer added successfully");
  }
  
  Serial.println("ESP-NOW initialized successfully");
  Serial.println("=== GESTURE CONTROLS ===");
  Serial.println("Tilt Forward: Move Forward");
  Serial.println("Tilt Backward: Move Backward");
  Serial.println("Tilt Left: Turn Left");
  Serial.println("Tilt Right: Turn Right");
  Serial.println("Keep Level: Stop");
  Serial.println("========================");
}

void loop() {
  if (mpuConnected) {
    readMPU6500();
    
    controlData.servo1 = constrain(map(pitch, -30, 30, 0, 180), 0, 180);
    controlData.servo2 = constrain(map(roll, -30, 30, 0, 180), 0, 180);
    controlData.servo3 = 90;
    controlData.servo4 = 90;
    controlData.emergency_stop = false;
    
    esp_err_t result = esp_now_send(receiverMAC, (uint8_t *)&controlData, sizeof(controlData));
    
    Serial.print("Pitch: "); Serial.print(pitch, 1);
    Serial.print("° Roll: "); Serial.print(roll, 1);
    Serial.print("° | S1: "); Serial.print(controlData.servo1);
    Serial.print(" S2: "); Serial.print(controlData.servo2);
    
    if (result == ESP_OK) {
      Serial.println(" | Sent ✓");
    } else {
      Serial.print(" | Send Failed: ");
      switch(result) {
        case ESP_ERR_ESPNOW_NOT_INIT:
          Serial.println("ESP-NOW not initialized");
          break;
        case ESP_ERR_ESPNOW_ARG:
          Serial.println("Invalid argument");
          break;
        case ESP_ERR_ESPNOW_INTERNAL:
          Serial.println("Internal error");
          break;
        case ESP_ERR_ESPNOW_NO_MEM:
          Serial.println("Out of memory");
          break;
        case ESP_ERR_ESPNOW_NOT_FOUND:
          Serial.println("Peer not found");
          break;
        default:
          Serial.println("Unknown error");
      }
    }
  }
  
  delay(100);
}

void printMACAddress() {
  Serial.print("MAC Address: ");
  Serial.println(WiFi.macAddress());
}

void scanForPeers() {
  Serial.println("Scanning for nearby ESP32 devices...");
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  int n = WiFi.scanNetworks();
  for (int i = 0; i < n; i++) {
    Serial.print("Network: ");
    Serial.println(WiFi.SSID(i));
  }
}
